===== src/main/resources/application.properties =====
server.port=8081
spring.application.name=auth-service

spring.datasource.url=jdbc:postgresql://localhost:5432/auth_db
spring.datasource.username=soumya
spring.datasource.password=1234

spring.jpa.hibernate.ddl-auto=update
spring.jpa.show-sql=true

jwt.secret=rZ6t4J2+9nA9s8yXQ0W4m9F0rVY5l5n7Cw1N6P0y2xk=
jwt.expiration=360000000
===== src/main/java/org/panda/authservice/security/PasswordConfig.java =====
package org.panda.authservice.security;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.crypto.password.PasswordEncoder;

@Configuration
public class PasswordConfig {
    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }
}
===== src/main/java/org/panda/authservice/security/SecurityConfig.java =====
package org.panda.authservice.security;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.web.SecurityFilterChain;

@Configuration
public class SecurityConfig {
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http.csrf(csrf -> csrf.disable())
                .authorizeHttpRequests(auth -> auth
                        .requestMatchers("/auth/**").permitAll()
                        .anyRequest().authenticated()
                );
        return http.build();
    }
}
===== src/main/java/org/panda/authservice/controller/AuthController.java =====
package org.panda.authservice.controller;

import jakarta.validation.Valid;
import org.panda.authservice.dto.*;
import org.panda.authservice.service.AuthService;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

@RestController
@RequestMapping("/auth")
public class AuthController {

    private final AuthService service;

    public AuthController(AuthService service) {
        this.service = service;
    }

    @PostMapping("/register")
    public ResponseEntity<Void> register(@RequestBody RegisterRequest request) {
        service.register(request);
        return ResponseEntity.status(HttpStatus.CREATED).build();
    }

    @PostMapping("/login")
    public ResponseEntity<String> login(@Valid @RequestBody LoginRequest request) {
        String token = service.login(request);
        return ResponseEntity.status(HttpStatus.OK).body(token);
    }
}
===== src/main/java/org/panda/authservice/exception/UserNotFoundException.java =====
package org.panda.authservice.exception;

public class UserNotFoundException extends RuntimeException{
    public UserNotFoundException(String msg){
        super(msg);
    }
}
===== src/main/java/org/panda/authservice/exception/UserAlreadyExistsException.java =====
package org.panda.authservice.exception;

public class UserAlreadyExistsException extends RuntimeException{
    public UserAlreadyExistsException(String msg){
        super(msg);
    }
}
===== src/main/java/org/panda/authservice/exception/GlobalExceptionHandler.java =====
package org.panda.authservice.exception;

import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.RestControllerAdvice;

@RestControllerAdvice
public class GlobalExceptionHandler {
    @ExceptionHandler(InvalidCredentialsException.class)
    public ResponseEntity<String> InvalidCredentialHandler(InvalidCredentialsException ex){
        return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(ex.getMessage());
    }

    @ExceptionHandler(UserAlreadyExistsException.class)
    public ResponseEntity<String> UserAlreadyExistsHandler(UserAlreadyExistsException ex){
        return ResponseEntity.status(HttpStatus.CONFLICT).body(ex.getMessage());
    }

    @ExceptionHandler(UserNotFoundException.class)
    public ResponseEntity<String> UserNotFoundHandler(UserNotFoundException ex){
        return ResponseEntity.status(HttpStatus.NOT_FOUND).body(ex.getMessage());
    }

    @ExceptionHandler(Exception.class)
    public ResponseEntity<String> GenericHandler(Exception ex){
        return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(ex.getMessage());
    }
}
===== src/main/java/org/panda/authservice/exception/InvalidCredentialsException.java =====
package org.panda.authservice.exception;

public class InvalidCredentialsException extends RuntimeException{
    public InvalidCredentialsException(String msg){
        super(msg);
    }
}
===== src/main/java/org/panda/authservice/entity/User.java =====
package org.panda.authservice.entity;

import jakarta.persistence.*;
import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;
import lombok.RequiredArgsConstructor;

@Entity
@Table(name = "users")
@Data
@NoArgsConstructor
@AllArgsConstructor
public class User {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private long id;

    @Column(unique = true, nullable = false)
    private String username;

    @Column(nullable = false)
    private String password;

    @Enumerated(EnumType.STRING)
    private Role role;
}
===== src/main/java/org/panda/authservice/entity/Role.java =====
package org.panda.authservice.entity;

public enum Role {
    USER,
    ADMIN
}
===== src/main/java/org/panda/authservice/dto/LoginRequest.java =====
package org.panda.authservice.dto;

public class LoginRequest {
    public String username;
    public String password;
}
===== src/main/java/org/panda/authservice/dto/RegisterRequest.java =====
package org.panda.authservice.dto;

public class RegisterRequest {
    public String username;
    public String password;
}
===== src/main/java/org/panda/authservice/service/AuthService.java =====
package org.panda.authservice.service;

import org.panda.authservice.dto.LoginRequest;
import org.panda.authservice.dto.RegisterRequest;
import org.panda.authservice.entity.Role;
import org.panda.authservice.entity.User;
import org.panda.authservice.exception.InvalidCredentialsException;
import org.panda.authservice.exception.UserAlreadyExistsException;
import org.panda.authservice.exception.UserNotFoundException;
import org.panda.authservice.repository.UserRepository;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Service;

@Service
public class AuthService {
    private final UserRepository repo;
    private final PasswordEncoder encoder;
    private final JwtService jwtService;

    public AuthService(UserRepository repo, PasswordEncoder encoder, JwtService jwtService) {
        this.repo = repo;
        this.encoder = encoder;
        this.jwtService = jwtService;
    }

    public void register(RegisterRequest req) {
        if(repo.findByUsername(req.username).isPresent()) throw new UserAlreadyExistsException("Username already exists");
        User user = new User();
        user.setUsername(req.username);
        user.setPassword(encoder.encode(req.password));
        user.setRole(Role.USER);
        repo.save(user);
    }

    public String login(LoginRequest req) {
        User user = repo.findByUsername(req.username).orElseThrow(() -> new UserNotFoundException("User not found"));

        if (!encoder.matches(req.password, user.getPassword())) throw new InvalidCredentialsException("Invalid credentials");

        return jwtService.generateToken(user);
    }
}
===== src/main/java/org/panda/authservice/service/JwtService.java =====
package org.panda.authservice.service;

import io.jsonwebtoken.Jwts;
import io.jsonwebtoken.SignatureAlgorithm;
import org.panda.authservice.entity.User;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;

import java.util.Date;

@Service
public class JwtService {
    @Value("${jwt.secret}")
    private String secret;

    @Value("${jwt.expiration}")
    private long expiration;

    public String generateToken(User user) {
        return Jwts.builder()
                .setSubject(user.getUsername())
                .claim("userId", user.getId())
                .claim("role", user.getRole().name())
                .setIssuedAt(new Date())
                .setExpiration(new Date(System.currentTimeMillis() + expiration))
                .signWith(SignatureAlgorithm.HS256, secret)
                .compact();
    }
}
===== src/main/java/org/panda/authservice/AuthServiceApplication.java =====
package org.panda.authservice;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

@SpringBootApplication
public class AuthServiceApplication {

    public static void main(String[] args) {
        SpringApplication.run(AuthServiceApplication.class, args);
    }

}
===== src/main/java/org/panda/authservice/repository/UserRepository.java =====
package org.panda.authservice.repository;

import org.panda.authservice.entity.User;
import org.springframework.data.jpa.repository.JpaRepository;

import java.util.Optional;

public interface UserRepository extends JpaRepository<User, Long> {
    Optional<User> findByUsername(String username);
}
===== src/test/java/org/panda/authservice/AuthServiceApplicationTests.java =====
package org.panda.authservice;

import org.junit.jupiter.api.Test;
import org.springframework.boot.test.context.SpringBootTest;

@SpringBootTest
class AuthServiceApplicationTests {

    @Test
    void contextLoads() {
    }

}
