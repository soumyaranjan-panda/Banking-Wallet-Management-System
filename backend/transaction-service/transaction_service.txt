===== src/main/resources/application.properties =====
spring.application.name=transaction-service
server.port=8083

spring.datasource.url=jdbc:postgresql://localhost:5432/transaction_db
spring.datasource.username=soumya
spring.datasource.password=1234

spring.jpa.hibernate.ddl-auto=update
spring.jpa.show-sql=true

jwt.secret=rZ6t4J2+9nA9s8yXQ0W4m9F0rVY5l5n7Cw1N6P0y2xk=
===== src/main/java/org/panda/transactionservice/security/JwtUtil.java =====
package org.panda.transactionservice.security;

import io.jsonwebtoken.Claims;
import io.jsonwebtoken.Jwts;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Component;

@Component
public class JwtUtil {

    private static String SECRET;

    @Value("${jwt.secret}")
    public void setSecret(String secret) {
        JwtUtil.SECRET = secret;
    }

    public static Claims validateToken(String token) {
        return Jwts.parser()
                .setSigningKey(SECRET)
                .parseClaimsJws(token)
                .getBody();
    }
}
===== src/main/java/org/panda/transactionservice/security/SecurityConfig.java =====
package org.panda.transactionservice.security;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;

@Configuration
public class SecurityConfig {

    @Bean
    SecurityFilterChain filterChain(HttpSecurity http) throws Exception {

        http
                .csrf(csrf -> csrf.disable())
                .authorizeHttpRequests(auth ->
                        auth.anyRequest().authenticated()
                )
                .addFilterBefore(
                        new JwtAuthenticationFilter(),
                        UsernamePasswordAuthenticationFilter.class
                );

        return http.build();
    }
}
===== src/main/java/org/panda/transactionservice/security/JwtAuthenticationFilter.java =====
package org.panda.transactionservice.security;

import io.jsonwebtoken.Claims;
import jakarta.servlet.FilterChain;
import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.web.filter.OncePerRequestFilter;

import java.io.IOException;
import java.util.List;

public class JwtAuthenticationFilter extends OncePerRequestFilter {

    @Override
    protected void doFilterInternal(HttpServletRequest request,
                                    HttpServletResponse response,
                                    FilterChain filterChain)
            throws ServletException, IOException {

        String header = request.getHeader("Authorization");

        if (header != null && header.startsWith("Bearer ")) {

            Claims claims = JwtUtil.validateToken(header.substring(7));

            String role = claims.get("role", String.class);
            Long userId = claims.get("userId", Long.class);

            request.setAttribute("userId", userId);

            UsernamePasswordAuthenticationToken auth =
                    new UsernamePasswordAuthenticationToken(
                            claims.getSubject(),
                            null,
                            List.of(new SimpleGrantedAuthority("ROLE_" + role))
                    );

            SecurityContextHolder.getContext().setAuthentication(auth);
        }

        filterChain.doFilter(request, response);
    }
}
===== src/main/java/org/panda/transactionservice/controller/TransactionController.java =====
package org.panda.transactionservice.controller;

import jakarta.servlet.http.HttpServletRequest;
import lombok.RequiredArgsConstructor;
import org.panda.transactionservice.dto.TransferRequest;
import org.panda.transactionservice.entity.Transaction;
import org.panda.transactionservice.service.TransactionService;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/transaction")
@RequiredArgsConstructor
public class TransactionController {

    private final TransactionService service;

    @PostMapping("/transfer")
    public Transaction transfer(@RequestBody TransferRequest request, HttpServletRequest httpRequest) {
        String token = httpRequest.getHeader("Authorization");
        return service.transfer(request.getFromAccountId(), request.getToAccountId(), request.getAmount(), token);
    }

    @GetMapping("/history/{accountId}")
    public List<Transaction> history(@PathVariable Long accountId) {
        return service.history(accountId);
    }
}
===== src/main/java/org/panda/transactionservice/entity/Transaction.java =====
package org.panda.transactionservice.entity;

import jakarta.persistence.*;
import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.time.LocalDateTime;

@Entity
@Table(name = "transactions")
@Data
@NoArgsConstructor
@AllArgsConstructor
public class Transaction {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    private Long fromAccountId;
    private Long toAccountId;
    private Double amount;

    @Enumerated(EnumType.STRING)
    private TransactionType type;

    @Enumerated(EnumType.STRING)
    private TransactionStatus status;

    private LocalDateTime createdAt;
}
===== src/main/java/org/panda/transactionservice/entity/TransactionStatus.java =====
package org.panda.transactionservice.entity;

public enum TransactionStatus {
    SUCCESS,
    FAILED
}
===== src/main/java/org/panda/transactionservice/entity/TransactionType.java =====
package org.panda.transactionservice.entity;

public enum TransactionType {
    CREDIT,
    DEBIT,
    TRANSFER
}
===== src/main/java/org/panda/transactionservice/dto/TransferRequest.java =====
package org.panda.transactionservice.dto;

import lombok.Data;

@Data
public class TransferRequest {
    private Long fromAccountId;
    private Long toAccountId;
    private Double amount;
}
===== src/main/java/org/panda/transactionservice/dto/DebitRequest.java =====
package org.panda.transactionservice.dto;

import lombok.Data;

@Data
public class DebitRequest {
    private Long accountId;
    private Double amount;
}
===== src/main/java/org/panda/transactionservice/dto/CreditRequest.java =====
package org.panda.transactionservice.dto;

import lombok.Data;

@Data
public class CreditRequest {
    private Long accountId;
    private Double amount;
}
===== src/main/java/org/panda/transactionservice/TransactionServiceApplication.java =====
package org.panda.transactionservice;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.openfeign.EnableFeignClients;

@SpringBootApplication
@EnableFeignClients
public class TransactionServiceApplication {
    public static void main(String[] args) {
        SpringApplication.run(TransactionServiceApplication.class, args);
    }

}
===== src/main/java/org/panda/transactionservice/service/TransactionService.java =====
package org.panda.transactionservice.service;

import lombok.RequiredArgsConstructor;
import org.panda.transactionservice.client.AccountClient;
import org.panda.transactionservice.entity.*;
import org.panda.transactionservice.repository.TransactionRepository;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.LocalDateTime;
import java.util.List;

@Service
@RequiredArgsConstructor
public class TransactionService {

    private final TransactionRepository repository;
    private final AccountClient accountClient;

    @Transactional
    public Transaction transfer(Long fromAccountId, Long toAccountId, Double amount, String token) {
        Double balance = accountClient.getBalance(fromAccountId, token);

        if (balance < amount) {
            throw new RuntimeException("Insufficient balance");
        }

        accountClient.debit(fromAccountId, amount, token);
        accountClient.credit(toAccountId, amount, token);

        Transaction tx = new Transaction();
        tx.setFromAccountId(fromAccountId);
        tx.setToAccountId(toAccountId);
        tx.setAmount(amount);
        tx.setType(TransactionType.TRANSFER);
        tx.setStatus(TransactionStatus.SUCCESS);
        tx.setCreatedAt(LocalDateTime.now());

        return repository.save(tx);
    }

    public List<Transaction> history(Long accountId) {
        List<Transaction> list = repository.findByFromAccountId(accountId);
        list.addAll(repository.findByToAccountId(accountId));
        return list;
    }
}
===== src/main/java/org/panda/transactionservice/client/AccountClient.java =====
package org.panda.transactionservice.client;

import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.web.bind.annotation.*;

@FeignClient(name = "account-service", url = "http://localhost:8082")
public interface AccountClient {

    @GetMapping("/account/{id}/balance")
    Double getBalance(
            @PathVariable("id") Long accountId,
            @RequestHeader("Authorization") String token
    );

    @PutMapping("/account/debit/{id}")
    void debit(
            @PathVariable("id") Long accountId,
            @RequestParam Double amount,
            @RequestHeader("Authorization") String token
    );

    @PutMapping("/account/credit/{id}")
    void credit(
            @PathVariable("id") Long accountId,
            @RequestParam Double amount,
            @RequestHeader("Authorization") String token
    );
}
===== src/main/java/org/panda/transactionservice/repository/TransactionRepository.java =====
package org.panda.transactionservice.repository;

import org.panda.transactionservice.entity.Transaction;
import org.springframework.data.jpa.repository.JpaRepository;

import java.util.List;

public interface TransactionRepository extends JpaRepository<Transaction, Long> {

    List<Transaction> findByFromAccountId(Long accountId);

    List<Transaction> findByToAccountId(Long accountId);
}
===== src/test/java/org/panda/transactionservice/TransactionServiceApplicationTests.java =====
package org.panda.transactionservice;

import org.junit.jupiter.api.Test;
import org.springframework.boot.test.context.SpringBootTest;

@SpringBootTest
class TransactionServiceApplicationTests {

    @Test
    void contextLoads() {
    }

}
