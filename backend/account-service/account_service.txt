===== src/main/resources/application.properties =====
spring.application.name=account-service
server.port=8082

spring.datasource.url=jdbc:postgresql://localhost:5432/account_db
spring.datasource.username=soumya
spring.datasource.password=1234

spring.jpa.hibernate.ddl-auto=update
spring.jpa.show-sql=true

jwt.secret=rZ6t4J2+9nA9s8yXQ0W4m9F0rVY5l5n7Cw1N6P0y2xk=
===== src/main/java/org/panda/accountservice/security/JwtUtil.java =====
package org.panda.accountservice.security;

import io.jsonwebtoken.Claims;
import io.jsonwebtoken.Jwts;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Component;

@Component
public class JwtUtil {

    private static String SECRET;

    @Value("${jwt.secret}")
    public void setSecret(String secret) {
        JwtUtil.SECRET = secret;
    }

    public static Claims validateToken(String token) {
        return Jwts.parser()
                .setSigningKey(SECRET)
                .parseClaimsJws(token)
                .getBody();
    }
}
===== src/main/java/org/panda/accountservice/security/SecurityConfig.java =====
package org.panda.accountservice.security;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.web.SecurityFilterChain;

@Configuration
public class SecurityConfig {
    @Bean
    SecurityFilterChain filterChain(HttpSecurity http) throws Exception {

        http
                .csrf(csrf -> csrf.disable())
                .httpBasic(basic -> basic.disable())
                .formLogin(form -> form.disable())
                .authorizeHttpRequests(auth -> auth
                        .requestMatchers("/account/block/**").hasRole("ADMIN")
                        .anyRequest().authenticated()
                )
                .addFilterBefore(
                        new JwtAuthenticationFilter(),
                        org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter.class
                );

        return http.build();
    }

}
===== src/main/java/org/panda/accountservice/security/JwtAuthenticationFilter.java =====
package org.panda.accountservice.security;

import io.jsonwebtoken.Claims;
import jakarta.servlet.FilterChain;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.web.filter.OncePerRequestFilter;

import java.util.List;

public class JwtAuthenticationFilter extends OncePerRequestFilter {

    @Override
    protected void doFilterInternal(HttpServletRequest request,
                                    HttpServletResponse response,
                                    FilterChain filterChain) throws java.io.IOException, jakarta.servlet.ServletException {

        String header = request.getHeader("Authorization");

        if (header != null && header.startsWith("Bearer ")) {
            String token = header.substring(7);

            Claims claims = JwtUtil.validateToken(token);

            String role = claims.get("role", String.class);
            Long userId = claims.get("userId", Long.class);

            request.setAttribute("userId", userId);

            UsernamePasswordAuthenticationToken auth = new UsernamePasswordAuthenticationToken(
                    claims.getSubject(),
                    null,
                    List.of(new SimpleGrantedAuthority("ROLE_" + role))
            );

            SecurityContextHolder.getContext().setAuthentication(auth);
        }

        filterChain.doFilter(request, response);
    }
}
===== src/main/java/org/panda/accountservice/controller/AccountController.java =====
package org.panda.accountservice.controller;

import jakarta.servlet.http.HttpServletRequest;
import lombok.RequiredArgsConstructor;
import org.panda.accountservice.entity.Account;
import org.panda.accountservice.service.AccountService;
import org.springframework.web.bind.annotation.*;

@RestController
@RequestMapping("/account")
@RequiredArgsConstructor
public class AccountController {

    private final AccountService accountService;

    @PostMapping("/create")
    public Account createAccount(HttpServletRequest request) {
        Long userId = (Long) request.getAttribute("userId");
        System.out.println(userId);

        if (userId == null) {
            throw new RuntimeException("UserId not found in JWT");
        }

        return accountService.createAccount(userId);
    }

    @GetMapping("/{accountId}/balance")
    public Double getBalance(@PathVariable Long accountId,
                             HttpServletRequest request) {

        Long userId = (Long) request.getAttribute("userId");

        if (userId == null) {
            throw new RuntimeException("UserId not found in JWT");
        }

        return accountService.getAccount(accountId, userId).getBalance();
    }

    @PutMapping("/block/{accountId}")
    public void blockAccount(@PathVariable Long accountId) {
        accountService.blockAccount(accountId);
    }
}
===== src/main/java/org/panda/accountservice/exception/AccountBlockedException.java =====
package org.panda.accountservice.exception;

public class AccountBlockedException extends RuntimeException {

    public AccountBlockedException(String message) {
        super(message);
    }
}
===== src/main/java/org/panda/accountservice/exception/AccountNotFoundException.java =====
package org.panda.accountservice.exception;

public class AccountNotFoundException extends RuntimeException {

    public AccountNotFoundException(String message) {
        super(message);
    }
}
===== src/main/java/org/panda/accountservice/exception/GlobalExceptionHandler.java =====
package org.panda.accountservice.exception;

import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.RestControllerAdvice;

import java.time.LocalDateTime;
import java.util.HashMap;
import java.util.Map;

@RestControllerAdvice
public class GlobalExceptionHandler {

    @ExceptionHandler(AccountNotFoundException.class)
    public ResponseEntity<?> handleAccountNotFound(AccountNotFoundException ex) {

        return buildResponse(HttpStatus.NOT_FOUND, ex.getMessage());
    }

    @ExceptionHandler(AccountBlockedException.class)
    public ResponseEntity<?> handleAccountBlocked(AccountBlockedException ex) {

        return buildResponse(HttpStatus.FORBIDDEN, ex.getMessage());
    }

    @ExceptionHandler(Exception.class)
    public ResponseEntity<?> handleGeneric(Exception ex) {

        return buildResponse(HttpStatus.INTERNAL_SERVER_ERROR,
                "Something went wrong");
    }

    private ResponseEntity<Map<String, Object>> buildResponse(
            HttpStatus status, String message) {

        Map<String, Object> body = new HashMap<>();
        body.put("timestamp", LocalDateTime.now());
        body.put("status", status.value());
        body.put("error", status.getReasonPhrase());
        body.put("message", message);

        return new ResponseEntity<>(body, status);
    }
}
===== src/main/java/org/panda/accountservice/entity/Account.java =====
package org.panda.accountservice.entity;

import jakarta.persistence.*;
import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

@Entity
@Table(name = "accounts")
@Data
@NoArgsConstructor
@AllArgsConstructor
public class Account {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    private Long userId;
    private Double balance;
    private boolean blocked;
}
===== src/main/java/org/panda/accountservice/dto/AccountCreateRequest.java =====
package org.panda.accountservice.dto;

public class AccountCreateRequest {
    // empty for now (future use)
}
===== src/main/java/org/panda/accountservice/dto/AccountResponse.java =====
package org.panda.accountservice.dto;

public class AccountResponse {

    private Long accountId;
    private Double balance;
    private boolean blocked;
}
===== src/main/java/org/panda/accountservice/AccountServiceApplication.java =====
package org.panda.accountservice;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

@SpringBootApplication
public class AccountServiceApplication {

    public static void main(String[] args) {
        SpringApplication.run(AccountServiceApplication.class, args);
    }

}
===== src/main/java/org/panda/accountservice/service/AccountService.java =====
package org.panda.accountservice.service;

import lombok.RequiredArgsConstructor;
import org.panda.accountservice.entity.Account;
import org.panda.accountservice.exception.AccountBlockedException;
import org.panda.accountservice.exception.AccountNotFoundException;
import org.panda.accountservice.repository.AccountRepository;
import org.springframework.stereotype.Service;

@Service
@RequiredArgsConstructor
public class AccountService {

    private final AccountRepository accountRepository;

    public Account createAccount(Long userId) {
        Account account = new Account();
        account.setUserId(userId);
        account.setBalance(0.0);
        account.setBlocked(false);
        return accountRepository.save(account);
    }

    public Account getAccount(Long accountId, Long userId) {

        Account account = accountRepository
                .findByIdAndUserId(accountId, userId)
                .orElseThrow(() ->
                        new AccountNotFoundException("Account not found"));

        if (account.isBlocked()) {
            throw new AccountBlockedException("Account is blocked");
        }

        return account;
    }

    public void blockAccount(Long accountId) {

        Account account = accountRepository
                .findById(accountId)
                .orElseThrow(() ->
                        new AccountNotFoundException("Account not found with id " + accountId));

        account.setBlocked(true);
        accountRepository.save(account);
    }
}
===== src/main/java/org/panda/accountservice/repository/AccountRepository.java =====
package org.panda.accountservice.repository;

import org.panda.accountservice.entity.Account;
import org.springframework.data.jpa.repository.JpaRepository;

import java.util.List;
import java.util.Optional;

public interface AccountRepository extends JpaRepository<Account, Long> {
    List<Account> findAllByUserId(Long userId);

    Optional<Account> findByIdAndUserId(Long accountId, Long userId);
}
===== src/test/java/org/panda/accountservice/AccountServiceApplicationTests.java =====
package org.panda.accountservice;

import org.junit.jupiter.api.Test;
import org.springframework.boot.test.context.SpringBootTest;

@SpringBootTest
class AccountServiceApplicationTests {

    @Test
    void contextLoads() {
    }

}
